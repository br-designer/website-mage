# Story 1.1: Monorepo Setup & Project Scaffolding

<!-- Powered by BMAD™ Core -->

**Epic:** 1 - Foundation & Authentication  
**Status:** Draft  
**Created:** 2025-10-27  
**Updated:** 2025-10-27

---

## Story

**As a** developer,  
**I want** a properly configured monorepo with all core dependencies and build tools,  
**so that** I can develop frontend and backend code with shared utilities efficiently.

---

## Acceptance Criteria

1. Repository initialized with PNPM workspaces and Turborepo configuration
2. Workspace structure created with `packages/web` (Nuxt 4), `packages/workers` (Cloudflare Workers), `packages/shared` (shared types/utils)
3. TypeScript 5.3+ configured with strict mode and path aliases
4. ESLint, Prettier, and commitlint configured with pre-commit hooks
5. Root `package.json` includes workspace scripts: `dev`, `build`, `test`, `lint`
6. README documents setup instructions and workspace structure
7. `.gitignore` properly excludes `node_modules`, `.nuxt`, `dist`, `.wrangler`, and environment files

---

## Tasks / Subtasks

- [ ] **Task 1: Initialize Monorepo Structure** (AC: 1, 2)
  - [ ] Initialize git repository with `git init`
  - [ ] Create root `package.json` with workspace configuration
  - [ ] Create `pnpm-workspace.yaml` defining workspace packages
  - [ ] Create workspace directories: `packages/web`, `packages/workers`, `packages/shared`
  - [ ] Install PNPM 8.15.0 globally if not present: `npm install -g pnpm@8.15.0`
  - [ ] Run `pnpm install` to initialize workspace
- [ ] **Task 2: Configure Turborepo** (AC: 1, 5)
  - [ ] Install Turborepo: `pnpm add -w -D turbo@1.12.0`
  - [ ] Create `turbo.json` with pipeline configuration for dev, build, test, lint
  - [ ] Configure task dependencies and caching strategy
  - [ ] Add turbo scripts to root package.json: `turbo run dev`, `turbo run build`, `turbo run test`, `turbo run lint`

- [ ] **Task 3: Configure TypeScript** (AC: 3)
  - [ ] Install TypeScript: `pnpm add -w -D typescript@5.3.3`
  - [ ] Create root `tsconfig.json` with strict mode enabled
  - [ ] Configure path aliases for workspace packages: `@websitemage/*`
  - [ ] Create workspace-specific tsconfig files extending root config
  - [ ] Verify TypeScript compilation with `pnpm exec tsc --noEmit`

- [ ] **Task 4: Setup ESLint & Prettier** (AC: 4)
  - [ ] Install ESLint: `pnpm add -w -D eslint@8.56.0 @typescript-eslint/eslint-plugin @typescript-eslint/parser`
  - [ ] Create `.eslintrc.js` with TypeScript rules and workspace-aware configuration
  - [ ] Install Prettier: `pnpm add -w -D prettier@3.2.0 eslint-config-prettier eslint-plugin-prettier`
  - [ ] Create `.prettierrc` with formatting rules (2 spaces, single quotes, trailing commas)
  - [ ] Create `.prettierignore` to exclude build artifacts
  - [ ] Add lint scripts to root package.json
  - [ ] Verify ESLint works: `pnpm run lint`

- [ ] **Task 5: Configure Git Hooks** (AC: 4)
  - [ ] Install Husky: `pnpm add -w -D husky@9.0.0`
  - [ ] Initialize Husky: `pnpm exec husky install`
  - [ ] Create pre-commit hook: `.husky/pre-commit` running lint-staged
  - [ ] Install lint-staged: `pnpm add -w -D lint-staged`
  - [ ] Configure lint-staged in package.json to run ESLint and Prettier on staged files
  - [ ] Install commitlint: `pnpm add -w -D @commitlint/cli@18.6.0 @commitlint/config-conventional@18.6.0`
  - [ ] Create `.commitlintrc.js` with conventional commit rules
  - [ ] Create commit-msg hook: `.husky/commit-msg` running commitlint
  - [ ] Test hooks with a test commit

- [ ] **Task 6: Create .gitignore** (AC: 7)
  - [ ] Create comprehensive `.gitignore` excluding:
    - `node_modules/`
    - `.nuxt/`, `dist/`, `.output/`
    - `.wrangler/`, `.mf/`
    - `.env`, `.env.local`, `.env.*.local`
    - `*.log`, `.DS_Store`
    - IDE-specific files (`.vscode/`, `.idea/`)
  - [ ] Verify files are properly ignored with `git status`

- [ ] **Task 7: Create README Documentation** (AC: 6)
  - [ ] Create `README.md` with project overview
  - [ ] Document workspace structure and package purposes
  - [ ] Document prerequisites: Node.js 20+, PNPM 8.15+
  - [ ] Document setup instructions: clone, install, dev server
  - [ ] Document available scripts: dev, build, test, lint
  - [ ] Document environment variable setup (reference to .env.example)
  - [ ] Add architecture diagram reference link

- [ ] **Task 8: Initialize Package Workspaces** (AC: 2)
  - [ ] Create `packages/web/package.json` with Nuxt 4 placeholder
  - [ ] Create `packages/workers/package.json` for Cloudflare Workers
  - [ ] Create `packages/shared/package.json` for shared utilities
  - [ ] Add minimal TypeScript files in each workspace to verify compilation
  - [ ] Run `pnpm install` to link workspace dependencies

- [ ] **Task 9: Verify Monorepo Setup** (AC: 1-7)
  - [ ] Run `pnpm run lint` and verify no errors
  - [ ] Run `pnpm run build` and verify all workspaces build successfully
  - [ ] Test git hooks with a commit following conventional commit format
  - [ ] Verify TypeScript compilation across all workspaces
  - [ ] Create initial commit: `chore: initial monorepo setup with turborepo and pnpm workspaces`

---

## Dev Notes

### Previous Story Insights

This is the first story in the project. No previous story context available.

### Architecture Context

**[Source: docs/architecture.md - High Level Architecture]**

Website Mage employs a **serverless-first, edge-optimized architecture** built on three pillars: Nuxt 4 SSR for the frontend dashboard, Cloudflare Workers for API/cron layer, and Supabase for data/auth backend.

**Repository Structure:** Monorepo (PNPM workspaces + Turborepo)

**[Source: docs/architecture.md - Source Tree]**

Complete workspace structure:

```
website-mage/
├── packages/
│   ├── web/              # Nuxt 4 frontend (SSR)
│   ├── workers/          # Cloudflare Workers (API Gateway, Cron Jobs)
│   │   ├── api/          # API Gateway Worker
│   │   ├── uptime/       # Uptime monitoring cron
│   │   ├── psi/          # PageSpeed Insights cron
│   │   ├── rum/          # RUM beacon ingestion
│   │   ├── cleanup/      # Data cleanup cron
│   │   └── stripe-webhook/ # Stripe webhook handler
│   ├── rum-js/           # RUM client JavaScript snippet
│   └── shared/           # Shared TypeScript utilities
│       ├── types/        # Shared type definitions
│       ├── constants/    # Shared constants (tiers, limits)
│       └── utils/        # Shared utility functions
├── supabase/             # Supabase migrations
│   ├── migrations/
│   └── config.toml
├── package.json          # Root package with workspace scripts
├── pnpm-workspace.yaml
├── turbo.json
└── tsconfig.json
```

### Technology Stack

**[Source: docs/architecture.md - Tech Stack]**

| Technology | Version     | Purpose                                  |
| ---------- | ----------- | ---------------------------------------- |
| Node.js    | 20.11.0 LTS | Runtime environment                      |
| PNPM       | 8.15.0      | Package manager with workspace support   |
| Turborepo  | 1.12.0      | Monorepo build orchestration and caching |
| TypeScript | 5.3.3       | Type-safe JavaScript with strict mode    |
| ESLint     | 8.56.0      | JavaScript/TypeScript linting            |
| Prettier   | 3.2.0       | Code formatting                          |
| Husky      | 9.0.0       | Git hooks management                     |
| commitlint | 18.6.0      | Conventional commit enforcement          |

### File Locations

**Root Configuration Files:**

- `package.json` - Root package with workspace configuration
- `pnpm-workspace.yaml` - PNPM workspace definitions
- `turbo.json` - Turborepo pipeline and caching config
- `tsconfig.json` - Root TypeScript configuration
- `.eslintrc.js` - ESLint configuration
- `.prettierrc` - Prettier formatting rules
- `.commitlintrc.js` - Commitlint rules
- `.gitignore` - Git ignore patterns
- `README.md` - Project documentation

**Workspace Packages:**

- `packages/web/package.json` - Nuxt 4 frontend package
- `packages/workers/package.json` - Cloudflare Workers package
- `packages/shared/package.json` - Shared utilities package

**Git Hooks:**

- `.husky/pre-commit` - Runs lint-staged before commit
- `.husky/commit-msg` - Validates commit message format

### Configuration Details

**Root package.json structure:**

```json
{
  "name": "website-mage",
  "version": "1.0.0",
  "private": true,
  "engines": {
    "node": ">=20.11.0",
    "pnpm": ">=8.15.0"
  },
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "test": "turbo run test",
    "lint": "turbo run lint",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "prepare": "husky install"
  },
  "devDependencies": {
    "turbo": "^1.12.0",
    "typescript": "^5.3.3",
    "eslint": "^8.56.0",
    "@typescript-eslint/eslint-plugin": "^6.19.0",
    "@typescript-eslint/parser": "^6.19.0",
    "prettier": "^3.2.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-plugin-prettier": "^5.1.0",
    "husky": "^9.0.0",
    "lint-staged": "^15.2.0",
    "@commitlint/cli": "^18.6.0",
    "@commitlint/config-conventional": "^18.6.0"
  }
}
```

**pnpm-workspace.yaml:**

```yaml
packages:
  - 'packages/*'
```

**turbo.json configuration:**

```json
{
  "$schema": "https://turbo.build/schema.json",
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".nuxt/**", ".output/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {
      "dependsOn": ["^build"],
      "outputs": []
    },
    "test": {
      "dependsOn": ["^build"],
      "outputs": []
    }
  }
}
```

**tsconfig.json (root):**

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "paths": {
      "@websitemage/shared/*": ["./packages/shared/src/*"]
    }
  },
  "exclude": ["node_modules", "dist", ".nuxt", ".output", ".wrangler"]
}
```

**[Source: docs/architecture.md - Coding Standards]**

### Coding Standards

**ESLint Configuration:**

- TypeScript parser with strict type checking
- Airbnb base style guide
- Prettier integration for formatting
- No unused variables or imports
- Consistent import ordering

**Prettier Rules:**

- 2-space indentation
- Single quotes for strings
- Trailing commas (ES5)
- Semicolons required
- Line width: 100 characters
- End of line: LF

**Commitlint:**

- Conventional Commits format enforced
- Types allowed: `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`
- Format: `type(scope): subject` (e.g., `feat(monorepo): add turborepo configuration`)

### Critical Rules

**[Source: docs/architecture.md - Coding Standards - Critical Rules]**

1. **No console.log in production:** Use structured logging in Workers, Nuxt logging utilities
2. **TypeScript strict mode:** All `tsconfig.json` files must have `strict: true`
3. **No hardcoded secrets:** All sensitive values via environment variables
4. **Workspace dependencies:** Use workspace protocol for internal packages (e.g., `"@websitemage/shared": "workspace:*"`)

### Testing

**Test Strategy for Story 1.1:**

Since this story focuses on infrastructure setup, testing is verification-based:

1. **Verify PNPM workspaces:** Run `pnpm install` and confirm all packages link correctly
2. **Verify Turborepo:** Run `pnpm run build` and confirm task execution and caching
3. **Verify TypeScript:** Run `pnpm exec tsc --noEmit` across all workspaces
4. **Verify ESLint:** Run `pnpm run lint` and confirm no errors
5. **Verify Prettier:** Run `pnpm run format` and confirm formatting applied
6. **Verify Git hooks:**
   - Test pre-commit hook with a file change
   - Test commit-msg hook with invalid commit message (should fail)
   - Test commit-msg hook with valid conventional commit (should pass)
7. **Verify .gitignore:** Confirm build artifacts and node_modules are ignored

**No unit tests required for this infrastructure story.**

**[Source: docs/architecture.md - Test Strategy]**

Testing Philosophy: Test-after (tests written during implementation)  
Test Framework: Vitest for unit tests (to be setup in later stories)

---

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-27 | 1.0     | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

**Agent Model Used:** _To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent during implementation_

### Completion Notes

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent with all files created/modified:_

- Root configuration files
- Workspace package.json files
- Git hooks
- Documentation

---

## QA Results

_To be filled by QA Agent after story completion_
